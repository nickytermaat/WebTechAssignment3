/**
 * Created by Kris on 9/28/2016.
 */
var express = require('express');
var app = express();
var bodyParser = require('body-parser');
var mongoose = require('mongoose');
var jwt = require('jsonwebtoken');

//Connect to the database
mongoose.connect('mongodb://localhost/test');
var Schema = mongoose.Schema;
var Movie = require('MovieSchema.js');
var User = require('userSchema.js');
//Register bodyparser
app.use(bodyParser.urlencoded({extended: true}));
app.use(bodyParser.json());

//Set and start the server
var Server =
    app.listen(3000, function(){
        console.log("Example app on port " + Server.address().port);
        var user1 = new User({name: 'Kris', password: ''});

        user1.save(function(err, result){
            if(err){
                return console.error(err);
            }
        });
        console.log("Server started..");
    });

app.get('/list', function(req, res){
    var token = req.headers['authorization'];

    jwt.verify(token, "Thisismysecretkey", function(error, decoded){
        if(error){
            res.send(error);
            //Send error code
        } else {
            res.send("Hoi");
            //Something went wrong
            //Do something with the decoded parameter
        }
    })
});

var authenticateResource = require('../resources/jsonToken.js');
app.post('/api/getToken', function(req,res){
    authenticateResource(req, res);
});

var addMovieResource = require('../resources/addMovieResource.js');
app.post('/api/addMovie', function(req, res){
    addMovieResource(req, res);
});

//TODO: ADD PERSON
var addPersonResource = function(req, res); //Set require here
app.post('/api/registerUser', function(req, res){
    addPersonResource(req,res);
});

var getPersonResource = function(req, res);
app.get('/api/users', function(req, res){
    var token = req.headers['authorization'];
    jwt.verify(token, "thisismysecretkey", function(error, decoded){
        if(error){
            res.send(error);
        } else {
            res.send(User.find());
        }
    });

});

