/**
 * Created by Kris on 9/28/2016.
 */
var express = require('express');
var app = express();
var bodyParser = require('body-parser');
var mongoose = require('mongoose');
var jwt = require('jsonwebtoken');
var fs = require('fs');

//Connect to the database
//Updated to 127.0.0.1 because when the ethernet card is disabled, localhost can't be resolved to an IP
mongoose.connect('mongodb://127.0.0.1/testing3');
var Schema = mongoose.Schema;
var movieResource = require('../resources/moviesResource.js');
var ratingResource = require('../resources/ratingsResource');
//Register bodyparser
app.use(bodyParser.urlencoded({extended: true}));
app.use(bodyParser.json());

//Set and start the server
var Server =
    app.listen(3000, function(){
        console.log("Example app on port " + Server.address().port);
    });


var userResource = require('../resources/userResource.js');
app.post('/api/login', userResource.authenticate);
app.get('/api/getUser/:name', userResource.getUser);
app.get('/api/getUser', userResource.getAllUsers);
app.post('/api/addUser', userResource.addUser);

app.post('/api/addMovie', movieResource.addMovie);
app.get('/api/getMovies/:ttNumber', movieResource.getMovie);
app.get('/api/getMovies',  movieResource.getAllMovies);

app.get('/api/getMyRatings', ratingResource.getRatingsForUser);
app.get('/api/getAvgForMovie/:ttNumber', ratingResource.getAvgForMovie);
app.post('/api/addRating', ratingResource.addRating);
app.put('/api/updateRating', ratingResource.updateRating);
app.delete('/api/deleteRating', ratingResource.deleteRating);

app.get('/dropDB', function(){
    ratingResource.drop();
    userResource.drop();
    movieResource.drop();
})

app.use("/", express.static('./public'));
app.get("/:page", function(req, res){
    /* This function allows the user to navigate to pages without the .html extension */
    var name = 'public/'+req.params.page+'.html';
    fs.access(name, fs.R_OK, function(err){
        if(err){
            res.status(404);
            res.send("404 page not found");
        } else {
            res.sendfile(name);
        }
    })
})
